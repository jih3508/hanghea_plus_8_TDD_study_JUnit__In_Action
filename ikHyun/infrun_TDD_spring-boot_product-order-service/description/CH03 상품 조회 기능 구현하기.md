# 색션 3. 상품 조회 API 개발

## 상품 조회 기능 구현 하기

### GetProductResponse 조회 응답값 Class
```java
import org.springframework.util.Assert;

public record GetProductResponse(
        long id,
        String name,
        int price,
        DiscountPolicy discountPolicy
) {
    public GetProductResponse{
        Assert.notNull(id, "상품 ID는 필수입니다.");
        Assert.hasText(name, "상품명은 필수입니다.");
        Assert.notNull(discountPolicy, "할인 정책은 필수입니다.");
    }

}
```

### ProductSteps 등록 Test 기능 별도 Class로 분리 작업
```java
import io.restassured.RestAssured;
import io.restassured.response.ExtractableResponse;
import io.restassured.response.Response;
import org.springframework.http.MediaType;

public class ProductSteps {

    public static ExtractableResponse<Response> 상품등록요청(final AddProductRequest request){
        return RestAssured.given().log().all()
                .contentType(MediaType.APPLICATION_JSON_VALUE)
                .body(request)
                .when()
                .post("/products")
                .then()
                .log().all().extract();
    }

    public static AddProductRequest 상품등록요청_생성(){
        final String name = "상품명";
        final int price = 1000;
        final DiscountPolicy discountPolicy = DiscountPolicy.NONE;
        return new AddProductRequest(name, price, discountPolicy);
    }
}

```

### 상품 조회 기능 구현
#### ProductService
```java
    public GetProductResponse getProduct(final Long productId){
        final Product product = productPort.getProduct(productId);

        return new GetProductResponse(
                product.getId(),
                product.getName(),
                product.getPrice(),
                product.getDiscountPolicy()
        );
    }
```

#### ProductPort
```java
interface ProductPort {
    void save(final Product product);

    Product getProduct(Long productId);
}
```

#### ProductAdapter
```java
    @Override
    public Product getProduct(Long productId) {
        return productRepository.findById(productId)
                .orElseThrow(() -> new IllegalArgumentException("상품이 존재하지 않습니다."));
    }
```

#### ProductServiceTest 상품 조회 테스트
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class ProductServiceTest {

    @Autowired
    private ProductService productService;

    @Test
    void 상품조회(){
        // 상품등록
        productService.addProduct(ProductSteps.상품등록요청_생성());
        final long productId = 1L;

        // 상품을 조회
        final GetProductResponse response = productService.getProduct(productId);

        // 상품의 응답을 검증
        assertThat(response).isNotNull();

    }

}
```

#### 결과 Log
```text
Hibernate: 
    
    create table products (
       id bigint generated by default as identity,
        discount_policy integer,
        name varchar(255),
        price integer not null,
        primary key (id)
    )

Hibernate: 
    insert 
    into
        products
        (id, discount_policy, name, price) 
    values
        (default, ?, ?, ?)
Hibernate: 
    select
        product0_.id as id1_0_0_,
        product0_.discount_policy as discount2_0_0_,
        product0_.name as name3_0_0_,
        product0_.price as price4_0_0_ 
    from
        products product0_ 
    where
        product0_.id=?
```

## API 테스트로 전환하기

### ProductService에 Get Method 추가

```java
    @GetMapping("/{productId}")
    public ResponseEntity<GetProductResponse> getProduct(@PathVariable final Long productId){
        final Product product = productPort.getProduct(productId);

        final GetProductResponse response =  new GetProductResponse(
                product.getId(),
                product.getName(),
                product.getPrice(),
                product.getDiscountPolicy()
        );

        return ResponseEntity.ok(response);
    }
```


#### ProductApiTest에 상품조회() Test 
```java
    @Test
    void 상품조회(){
        ProductSteps.상품등록요청(ProductSteps.상품등록요청_생성());
        Long productId = 1L;

        final ExtractableResponse<Response> response = RestAssured.given().log().all()
                .when()
                .get("/products/{productId}", productId)
                .then().log().all()
                .extract();

        assertThat(response.statusCode()).isEqualTo(HttpStatus.OK.value());
        assertThat(response.jsonPath().getString("name")).isEqualTo("상품명");
    }
```
1. 상품 등록 → 등록한 key값은 AutoIncreament로 1부터 시작한다.
2. 등록한 상품 조회
##### 결과 Log
```text
HTTP/1.1 201 
Content-Length: 0
Date: Sun, 02 Mar 2025 18:45:52 GMT
Keep-Alive: timeout=60
Connection: keep-alive
Request method:	GET
Request URI:	http://localhost:9574/products/1
Proxy:			<none>
Request params:	<none>
Query params:	<none>
Form params:	<none>
Path params:	<none>
Headers:		Accept=*/*
Cookies:		<none>
Multiparts:		<none>
Body:			<none>
Hibernate: 
    select
        product0_.id as id1_0_0_,
        product0_.discount_policy as discount2_0_0_,
        product0_.name as name3_0_0_,
        product0_.price as price4_0_0_ 
    from
        products product0_ 
    where
        product0_.id=?
HTTP/1.1 200 
Content-Type: application/json
Transfer-Encoding: chunked
Date: Sun, 02 Mar 2025 18:45:52 GMT
Keep-Alive: timeout=60
Connection: keep-alive

{
    "id": 1,
    "name": "상품명",
    "price": 1000,
    "discountPolicy": "NONE"
}
```